<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Appliance Inventory</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #f8f9fa;
            --bg-hover: #f0f7ff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #e0e0e0;
            --border-color-light: #ddd;
            --shadow: rgba(0,0,0,0.1);
            --shadow-hover: rgba(0,0,0,0.1);
            --card-bg: #ffffff;
            --header-bg: #333333;
            --header-text: #ffffff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1a1a1a;
                --bg-secondary: #0d0d0d;
                --bg-tertiary: #2a2a2a;
                --bg-hover: #1a2a3a;
                --text-primary: #e0e0e0;
                --text-secondary: #b0b0b0;
                --text-tertiary: #808080;
                --border-color: #2a2a2a;
                --border-color-light: #333333;
                --shadow: rgba(0,0,0,0.3);
                --shadow-hover: rgba(0,0,0,0.4);
                --card-bg: #242424;
                --header-bg: #1a1a1a;
                --header-text: #e0e0e0;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow);
            overflow: hidden;
        }

        header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 30px;
            border-bottom: 3px solid #4a90e2;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .address {
            opacity: 0.95;
            font-size: 1.1em;
        }

        .controls {
            padding: 20px 30px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn-create-new {
            padding: 12px 32px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-create-new:hover {
            background: #45a049;
        }

        .drop-zone-divider {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid var(--border-color-light);
            width: 100%;
            text-align: center;
        }

        .drop-zone-divider p {
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid var(--border-color-light);
            border-radius: 8px;
            font-size: 1em;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #4a90e2;
            background: var(--bg-primary);
            color: #4a90e2;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #4a90e2;
            color: white;
        }

        .filter-btn.active {
            background: #4a90e2;
            color: white;
        }

        .content {
            padding: 30px;
        }

        .group-section {
            margin-bottom: 40px;
        }

        .group-title {
            font-size: 1.5em;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color-light);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
        }

        .product-card:hover {
            box-shadow: 0 8px 20px var(--shadow-hover);
            transform: translateY(-2px);
        }

        .product-card.hidden {
            display: none;
        }

        .product-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 4px;
        }

        .product-title-section {
            flex: 1;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .lifespan-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 8px;
        }

        .lifespan-indicator.good {
            background: #4caf50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
        }

        .lifespan-indicator.warning {
            background: #ff9800;
            box-shadow: 0 0 8px rgba(255, 152, 0, 0.4);
        }

        .lifespan-indicator.critical {
            background: #f44336;
            box-shadow: 0 0 8px rgba(244, 67, 54, 0.4);
        }

        .product-card h3 {
            font-size: 1.3em;
            color: var(--text-primary);
            margin: 0;
        }

        .product-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .btn-icon {
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color-light);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .product-subtitle {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 12px;
        }

        .product-purchase-date {
            color: var(--text-tertiary);
            font-size: 0.85em;
            margin-top: 8px;
        }

        .lifespan-info {
            margin-top: 15px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.9em;
        }

        .lifespan-info.good {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4caf50;
        }

        .lifespan-info.warning {
            background: rgba(255, 152, 0, 0.1);
            border-left: 4px solid #ff9800;
        }

        .lifespan-info.critical {
            background: rgba(244, 67, 54, 0.1);
            border-left: 4px solid #f44336;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
            font-size: 1.2em;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.5em;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 1.1em;
            color: var(--text-tertiary);
            margin-bottom: 30px;
        }

        .empty-state button {
            padding: 12px 24px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .empty-state button:hover {
            background: #357abd;
        }

        .drop-zone {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            padding: 60px 40px;
            margin: 40px;
            border: 3px dashed var(--border-color-light);
            border-radius: 12px;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: #4a90e2;
            background: var(--bg-hover);
        }

        .drop-zone-icon {
            font-size: 4em;
            margin-bottom: 20px;
            color: var(--text-tertiary);
        }

        .drop-zone h2 {
            color: var(--text-primary);
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .drop-zone p {
            color: var(--text-secondary);
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .file-input-btn {
            padding: 12px 24px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-input-btn:hover {
            background: #357abd;
        }

        .hidden {
            display: none;
        }

        .btn-delete-modal {
            width: 100%;
            padding: 12px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s;
        }

        .btn-delete-modal:hover {
            background: #d32f2f;
        }

        .btn-add, .btn-download {
            padding: 10px 20px;
            border: 2px solid #4a90e2;
            background: #4a90e2;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-add:hover, .btn-download:hover {
            background: #357abd;
            border-color: #357abd;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-tertiary);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color-light);
            border-radius: 6px;
            font-size: 1em;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .btn-save, .btn-cancel {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save {
            background: #4a90e2;
            color: white;
        }

        .btn-save:hover {
            background: #357abd;
        }

        .btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-cancel:hover {
            background: var(--border-color);
        }

        .manual-row {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .manual-row input {
            margin-bottom: 0;
        }

        .btn-remove-manual {
            padding: 10px 15px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-remove-manual:hover {
            background: #d32f2f;
        }

        .btn-add-manual {
            margin-top: 10px;
            padding: 8px 16px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-add-manual:hover {
            background: #357abd;
        }

        .manuals-container {
            position: relative;
        }

        .manuals-button {
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color-light);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .manuals-button:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .manuals-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            padding: 10px;
            background: var(--card-bg);
            border: 1px solid var(--border-color-light);
            border-radius: 6px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 100;
            min-width: 200px;
        }

        .manuals-dropdown.show {
            display: block;
        }

        .manuals-dropdown a {
            display: block;
            color: #4a90e2;
            text-decoration: none;
            padding: 6px 0;
            font-size: 0.9em;
        }

        .manuals-dropdown a:hover {
            text-decoration: underline;
        }

        .stats {
            display: flex;
            gap: 20px;
            padding: 20px 30px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4a90e2;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.5em;
            }

            .stats {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="dropZoneContainer">
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-icon">üìÅ</div>
                <h2>Drop your inventory.json file here</h2>
                <p>or click to browse</p>
                <button class="file-input-btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
                <div class="drop-zone-divider">
                    <p>Or start fresh</p>
                    <button class="btn-create-new" onclick="openAddHomeModal()">Create New Home</button>
                </div>
            </div>
        </div>

        <div id="inventoryContainer" class="hidden">
            <header id="header">
                <!-- Will be populated by JavaScript -->
            </header>

            <div class="stats" id="stats">
                <!-- Will be populated by JavaScript -->
            </div>

            <div class="controls">
                <input type="text" class="search-box" id="searchBox" placeholder="Search by type, brand, model, or serial number...">
                <button class="btn-add" onclick="openAddModal()">Add Appliance</button>
                <button class="btn-download" onclick="downloadJSON()">Download JSON</button>
            </div>

            <div class="content" id="content">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add Home Modal -->
    <div id="addHomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Home</h2>
                <button class="modal-close" onclick="closeHomeModal()">&times;</button>
            </div>
            <form id="addHomeForm" onsubmit="saveNewHome(event)">
                <div class="form-group">
                    <label>Home Name *</label>
                    <input type="text" id="home_name" required placeholder="e.g., My Home in Denver">
                </div>
                <div class="form-group">
                    <label>Address *</label>
                    <input type="text" id="home_address" required placeholder="e.g., 123 Main Street">
                </div>
                <div class="form-group">
                    <label>City *</label>
                    <input type="text" id="home_city" required>
                </div>
                <div class="form-group">
                    <label>State *</label>
                    <input type="text" id="home_state" required maxlength="2" placeholder="e.g., CO">
                </div>
                <div class="form-group">
                    <label>Zip Code *</label>
                    <input type="text" id="home_zip" required placeholder="e.g., 80516">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeHomeModal()">Cancel</button>
                    <button type="submit" class="btn-save">Create Home</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit/Add Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Edit Appliance</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="editForm" onsubmit="saveAppliance(event)">
                <div class="form-group">
                    <label>Type *</label>
                    <input type="text" id="edit_type" required>
                </div>
                <div class="form-group">
                    <label>Group *</label>
                    <input type="text" id="edit_group" list="groupList" required placeholder="e.g., Kitchen, Mechanical, Laundry">
                    <datalist id="groupList">
                        <!-- Will be populated dynamically -->
                    </datalist>
                </div>
                <div class="form-group">
                    <label>Brand</label>
                    <input type="text" id="edit_brand">
                </div>
                <div class="form-group">
                    <label>Model Number</label>
                    <input type="text" id="edit_modelNumber">
                </div>
                <div class="form-group">
                    <label>Serial Number</label>
                    <input type="text" id="edit_serialNumber">
                </div>
                <div class="form-group">
                    <label>Year Installed</label>
                    <input type="number" id="edit_yearInstalled" min="1900" max="2100">
                </div>
                <div class="form-group">
                    <label>Estimated Lifespan (Min Years)</label>
                    <input type="number" id="edit_lifespanMin" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Estimated Lifespan (Max Years)</label>
                    <input type="number" id="edit_lifespanMax" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Purchase Date</label>
                    <input type="text" id="edit_purchaseDate" placeholder="YYYY/MM/DD">
                </div>
                <div class="form-group">
                    <label>Purchase Price</label>
                    <input type="number" id="edit_purchasePrice" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="edit_notes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Manuals</label>
                    <div id="manualsList"></div>
                    <button type="button" class="btn-add-manual" onclick="addManualRow()">+ Add Manual</button>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-save">Save</button>
                </div>
                <button type="button" class="btn-delete-modal" id="deleteButton" onclick="deleteCurrentAppliance()" style="display: none;">Delete Appliance</button>
            </form>
        </div>
    </div>

    <script>
        let inventoryData = null;

        // Set up drag and drop handlers
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Highlight drop zone when dragging over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('drag-over');
            }, false);
        });

        // Handle dropped files
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            handleFiles(files);
        }, false);

        // Handle file input change
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            handleFiles(files);
        });

        // Click on drop zone to trigger file input
        dropZone.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') {
                fileInput.click();
            }
        });

        function handleFiles(files) {
            if (files.length === 0) return;

            const file = files[0];

            if (!file.name.endsWith('.json')) {
                alert('Please upload a JSON file');
                return;
            }

            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    inventoryData = JSON.parse(e.target.result);
                    loadData();
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                }
            };

            reader.onerror = () => {
                alert('Error reading file');
            };

            reader.readAsText(file);
        }

        function loadData() {
            if (!inventoryData) return;

            // Hide drop zone and show inventory
            document.getElementById('dropZoneContainer').classList.add('hidden');
            document.getElementById('inventoryContainer').classList.remove('hidden');

            renderAll();
        }

        // Calculate dynamic age and lifespan data
        function calculateLifespanData(product) {
            const currentYear = new Date().getFullYear();

            if (product.yearInstalled === null) {
                return {
                    age: null,
                    lifespanRemainingMin: null,
                    lifespanRemainingMax: null
                };
            }

            const age = currentYear - product.yearInstalled;
            const [lifespanMin, lifespanMax] = product.estimatedLifespanYears;

            return {
                age: age,
                lifespanRemainingMin: lifespanMin - age,
                lifespanRemainingMax: lifespanMax - age
            };
        }

        function renderAll() {
            if (!inventoryData || !inventoryData.homes.length) return;

            const home = inventoryData.homes[0];
            renderHeader(home);
            renderStats(home.products);
            renderProducts(home.products);
            setupEventListeners();
        }

        // Home management functions
        function openAddHomeModal() {
            document.getElementById('addHomeForm').reset();
            document.getElementById('addHomeModal').classList.add('show');
        }

        function closeHomeModal() {
            document.getElementById('addHomeModal').classList.remove('show');
        }

        function saveNewHome(event) {
            event.preventDefault();

            // Create a brand new inventory with this home
            inventoryData = {
                homes: [{
                    name: document.getElementById('home_name').value,
                    address: document.getElementById('home_address').value,
                    city: document.getElementById('home_city').value,
                    state: document.getElementById('home_state').value.toUpperCase(),
                    zip: document.getElementById('home_zip').value,
                    products: []
                }]
            };

            closeHomeModal();
            loadData();
        }

        function renderHeader(home) {
            document.getElementById('header').innerHTML = `
                <h1>${home.name}</h1>
                <div class="address">${home.address}, ${home.city}, ${home.state} ${home.zip}</div>
            `;
        }

        function renderStats(products) {
            const total = products.length;
            let critical = 0;
            let warning = 0;

            products.forEach(p => {
                const data = calculateLifespanData(p);
                if (data.lifespanRemainingMax !== null) {
                    if (data.lifespanRemainingMax < 0) {
                        critical++;
                    } else if (data.lifespanRemainingMax <= 5) {
                        warning++;
                    }
                }
            });

            document.getElementById('stats').innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total Appliances</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${critical}</div>
                    <div class="stat-label">Needs Replacement</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${warning}</div>
                    <div class="stat-label">Replace Soon</div>
                </div>
            `;
        }

        function getLifespanStatus(product) {
            const data = calculateLifespanData(product);
            if (data.lifespanRemainingMax === null) return 'unknown';
            if (data.lifespanRemainingMax < 0) return 'critical';
            if (data.lifespanRemainingMax <= 5) return 'warning';
            return 'good';
        }

        function renderProducts(products) {
            if (products.length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üè†</div>
                        <h3>No appliances yet</h3>
                        <p>Add an appliance to get started</p>
                        <button onclick="openAddModal()">Add Your First Appliance</button>
                    </div>
                `;
                return;
            }

            const groups = {};
            products.forEach((product, index) => {
                if (!groups[product.group]) {
                    groups[product.group] = [];
                }
                groups[product.group].push({ product, index });
            });

            let html = '';
            Object.keys(groups).sort().forEach(groupName => {
                html += `
                    <div class="group-section" data-group="${groupName}">
                        <h2 class="group-title">${groupName}</h2>
                        <div class="products-grid">
                            ${groups[groupName].map(item => renderProductCard(item.product, item.index)).join('')}
                        </div>
                    </div>
                `;
            });

            document.getElementById('content').innerHTML = html;
        }

        function renderProductCard(product, index) {
            const status = getLifespanStatus(product);
            const data = calculateLifespanData(product);
            let lifespanText = '';

            // Build subtitle with brand, model, and serial
            let subtitle = product.brand || '';
            if (product.modelNumber) {
                subtitle += (subtitle ? ' ' : '') + product.modelNumber;
            }
            if (product.serialNumber) {
                subtitle += (subtitle ? ' ‚Ä¢ ' : '') + product.serialNumber;
            }

            // Simplified lifespan text
            if (data.age !== null) {
                if (status === 'critical') {
                    lifespanText = `${data.age} years old (installed ${product.yearInstalled})<br>Past estimated lifespan - consider replacing`;
                } else if (status === 'warning' || status === 'good') {
                    lifespanText = `${data.age} years old (installed ${product.yearInstalled})<br>Replace in ${data.lifespanRemainingMin}-${data.lifespanRemainingMax} years`;
                }
            } else {
                const [min, max] = product.estimatedLifespanYears;
                lifespanText = `Expected lifespan: ${min}-${max} years`;
            }

            return `
                <div class="product-card" data-group="${product.group}" data-status="${status}"
                     data-search="${(product.type + ' ' + product.brand + ' ' + product.modelNumber + ' ' + product.serialNumber).toLowerCase()}">
                    <div class="product-header">
                        <div class="product-title-section">
                            <div class="lifespan-indicator ${status}"></div>
                            <div>
                                <h3>${product.type}</h3>
                                ${subtitle ? `<div class="product-subtitle">${subtitle}</div>` : ''}
                            </div>
                        </div>
                        <div class="product-actions">
                            ${product.manuals && product.manuals.length > 0 ? `
                                <div class="manuals-container">
                                    <button class="manuals-button btn-icon" onclick="toggleManuals(event, ${index})">
                                        üìÑ ${product.manuals.length}
                                    </button>
                                    <div class="manuals-dropdown" id="manuals-${index}">
                                        ${product.manuals.map(manual => `<a href="${manual.url}" target="_blank" rel="noopener noreferrer">${manual.name} ‚Üó</a>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <button class="btn-icon" onclick="openEditModal(${index})">‚úèÔ∏è</button>
                        </div>
                    </div>
                    ${lifespanText ? `<div class="lifespan-info ${status}">${lifespanText}</div>` : ''}
                    ${product.purchaseDate ? `<div class="product-purchase-date">Purchased: ${product.purchaseDate}</div>` : ''}
                </div>
            `;
        }

        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchBox').addEventListener('input', (e) => {
                filterProducts();
            });
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const cards = document.querySelectorAll('.product-card');
            let visibleCount = 0;

            cards.forEach(card => {
                const matchesSearch = searchTerm === '' || card.dataset.search.includes(searchTerm);

                if (matchesSearch) {
                    card.classList.remove('hidden');
                    visibleCount++;
                } else {
                    card.classList.add('hidden');
                }
            });

            // Show/hide group sections
            document.querySelectorAll('.group-section').forEach(section => {
                const visibleCards = section.querySelectorAll('.product-card:not(.hidden)');
                if (visibleCards.length === 0) {
                    section.style.display = 'none';
                } else {
                    section.style.display = 'block';
                }
            });

            // Show no results message
            if (visibleCount === 0) {
                if (!document.querySelector('.no-results')) {
                    document.getElementById('content').innerHTML += '<div class="no-results">No products found matching your criteria.</div>';
                }
            } else {
                const noResults = document.querySelector('.no-results');
                if (noResults) noResults.remove();
            }
        }

        // Modal and editing functions
        let currentEditingIndex = -1;
        let manualCounter = 0;

        function toggleManuals(event, index) {
            event.stopPropagation();
            const dropdown = document.getElementById(`manuals-${index}`);
            const wasShown = dropdown.classList.contains('show');

            // Close all dropdowns
            document.querySelectorAll('.manuals-dropdown').forEach(d => d.classList.remove('show'));

            // Toggle this one
            if (!wasShown) {
                dropdown.classList.add('show');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.manuals-container')) {
                document.querySelectorAll('.manuals-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        function addManualRow(name = '', url = '') {
            const manualsList = document.getElementById('manualsList');
            const id = `manual_${manualCounter++}`;

            const row = document.createElement('div');
            row.className = 'manual-row';
            row.id = id;
            row.innerHTML = `
                <input type="text" placeholder="Manual name" value="${name}" data-manual-name>
                <input type="url" placeholder="https://..." value="${url}" data-manual-url>
                <button type="button" class="btn-remove-manual" onclick="removeManualRow('${id}')">Remove</button>
            `;

            manualsList.appendChild(row);
        }

        function removeManualRow(id) {
            document.getElementById(id).remove();
        }

        function populateGroupList() {
            const home = inventoryData.homes[0];
            const groups = new Set(home.products.map(p => p.group));
            const datalist = document.getElementById('groupList');

            datalist.innerHTML = '';
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                datalist.appendChild(option);
            });
        }

        function openAddModal() {
            currentEditingIndex = -1;
            document.getElementById('modalTitle').textContent = 'Add Appliance';
            document.getElementById('editForm').reset();
            document.getElementById('manualsList').innerHTML = '';
            document.getElementById('deleteButton').style.display = 'none';
            populateGroupList();
            document.getElementById('editModal').classList.add('show');
        }

        function openEditModal(index) {
            const home = inventoryData.homes[0];
            currentEditingIndex = index;
            const product = home.products[index];

            document.getElementById('modalTitle').textContent = 'Edit Appliance';
            document.getElementById('edit_type').value = product.type || '';
            document.getElementById('edit_group').value = product.group || '';
            document.getElementById('edit_brand').value = product.brand || '';
            document.getElementById('edit_modelNumber').value = product.modelNumber || '';
            document.getElementById('edit_serialNumber').value = product.serialNumber || '';
            document.getElementById('edit_yearInstalled').value = product.yearInstalled || '';
            document.getElementById('edit_lifespanMin').value = product.estimatedLifespanYears ? product.estimatedLifespanYears[0] : '';
            document.getElementById('edit_lifespanMax').value = product.estimatedLifespanYears ? product.estimatedLifespanYears[1] : '';
            document.getElementById('edit_purchaseDate').value = product.purchaseDate || '';
            document.getElementById('edit_purchasePrice').value = product.purchasePrice || '';
            document.getElementById('edit_notes').value = product.notes || '';

            // Populate manuals
            document.getElementById('manualsList').innerHTML = '';
            if (product.manuals && product.manuals.length > 0) {
                product.manuals.forEach(manual => {
                    addManualRow(manual.name, manual.url);
                });
            }

            // Show delete button when editing
            document.getElementById('deleteButton').style.display = 'block';

            populateGroupList();
            document.getElementById('editModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEditingIndex = -1;
        }

        function saveAppliance(event) {
            event.preventDefault();

            const home = inventoryData.homes[0];
            const lifespanMin = parseInt(document.getElementById('edit_lifespanMin').value) || 10;
            const lifespanMax = parseInt(document.getElementById('edit_lifespanMax').value) || 15;
            const yearInstalled = document.getElementById('edit_yearInstalled').value;

            // Collect manuals from the form
            const manuals = [];
            document.querySelectorAll('#manualsList .manual-row').forEach(row => {
                const name = row.querySelector('[data-manual-name]').value.trim();
                const url = row.querySelector('[data-manual-url]').value.trim();
                if (name && url) {
                    manuals.push({ name, url });
                }
            });

            const product = {
                type: document.getElementById('edit_type').value,
                group: document.getElementById('edit_group').value,
                brand: document.getElementById('edit_brand').value,
                modelNumber: document.getElementById('edit_modelNumber').value,
                serialNumber: document.getElementById('edit_serialNumber').value,
                yearInstalled: yearInstalled ? parseInt(yearInstalled) : null,
                estimatedLifespanYears: [lifespanMin, lifespanMax],
                purchaseDate: document.getElementById('edit_purchaseDate').value,
                purchasePrice: document.getElementById('edit_purchasePrice').value,
                installationDate: "",
                warrantyDate: "",
                extendedWarrantyDate: "",
                recallReported: "No",
                manuals: manuals,
                notes: document.getElementById('edit_notes').value
            };

            if (currentEditingIndex === -1) {
                // Adding new product
                home.products.push(product);
            } else {
                // Editing existing product
                home.products[currentEditingIndex] = product;
            }

            closeModal();
            renderAll();
        }

        function deleteCurrentAppliance() {
            if (currentEditingIndex === -1) return;

            const home = inventoryData.homes[0];
            const product = home.products[currentEditingIndex];

            if (!confirm(`Are you sure you want to delete "${product.type}"?`)) {
                return;
            }

            home.products.splice(currentEditingIndex, 1);
            closeModal();
            renderAll();
        }

        function downloadJSON() {
            const dataStr = JSON.stringify(inventoryData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = 'inventory.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                closeModal();
            }
        });

        document.getElementById('addHomeModal').addEventListener('click', (e) => {
            if (e.target.id === 'addHomeModal') {
                closeHomeModal();
            }
        });
    </script>
</body>
</html>
